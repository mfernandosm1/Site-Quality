<% layout('layout') -%>
<div class="card">
  <h3>ğŸ’³ Formas de Pagamento</h3>
  <p class="muted">Edite o conteÃºdo principal. O restante do HTML fica preservado.</p>
  <textarea id="editorPagto"><%- html %></textarea>
  <div class="actions">
    <button id="savePagto" class="btn primary">ğŸ’¾ Salvar (Visual)</button>
    <a href="/pagamentos" class="btn ghost">ğŸ”„ Recarregar do arquivo</a>
  </div>
</div>

<div class="card">
  <h4>Modo CÃ³digo (HTML do &lt;main&gt;)</h4>
  <form method="post" action="/pagamentos/salvar">
    <textarea name="html" rows="14" class="code"><%- html %></textarea>
    <button class="btn">Salvar (CÃ³digo)</button>
  </form>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
let editorPagto;
ClassicEditor.create(document.querySelector('#editorPagto'), {
  toolbar: [
    'heading','|','bold','italic','underline','link','bulletedList','numberedList','blockQuote',
    '|','insertTable','undo','redo','sourceEditing'
  ],
  htmlEmbed: { showPreviews: true },
  htmlSupport: {
    allow: [ { name: /.*/, attributes: true, classes: true, styles: true } ]
  }
}).then(e=>{
  editorPagto = e;
  document.getElementById('savePagto').addEventListener('click', async ()=>{
    const conteudo = editorPagto.getData();
    const resp = await fetch('/pagamentos/salvar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ html: conteudo })
    });
    alert(resp.ok ? 'âœ… Salvo!' : 'âŒ Erro ao salvar.');
    if (resp.ok) location.href = '/pagamentos';
  });
}).catch(console.error);
</script>
