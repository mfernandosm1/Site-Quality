<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Produtos - Quality Celulares</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #c90000; margin-bottom: 20px; }
    .section { margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    button { margin-top: 10px; padding: 8px 12px; background: #c90000; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:hover { background: #a00000; }
    .item { padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 300px; }
    img.preview-img { max-width: 120px; display: block; margin: 5px 0; border-radius: 6px; }
    .toolbar { margin-bottom: 15px; }
    a.voltar { display:inline-block; margin-bottom:15px; color:#c90000; font-weight:bold; text-decoration:none; }
  </style>
</head>
<body>
  <h1>üì¶ Gerenciar Produtos</h1>
  <p><a href="admin.html" class="voltar">üîô Voltar ao Painel Administrativo</a></p>

  <div class="toolbar">
    <button onclick="novoProduto()">‚ûï Novo Produto</button>
    <button onclick="salvarProdutos()">üíæ Salvar Altera√ß√µes</button>
    <select id="filtro-categoria" onchange="filtrarProdutos()">
      <option value="">Todas Categorias</option>
    </select>
  </div>

  <div id="lista-produtos"></div>

  <script>
    const API = "http://localhost:3000/api";
    let produtosTemp = [];
    let categoriasTemp = [];

    // ========================
    // LISTAGEM
    // ========================
    async function listarProdutos() {
      const res = await fetch(`${API}/products`);
      produtosTemp = await res.json();
      renderProdutos();
    }

    async function listarCategorias() {
      const res = await fetch(`${API}/categories`);
      categoriasTemp = await res.json();
      const filtro = document.getElementById("filtro-categoria");
      filtro.innerHTML = `<option value="">Todas Categorias</option>`;
      categoriasTemp.forEach(c => {
        filtro.innerHTML += `<option value="${c.slug}">${c.nome}</option>`;
      });
    }

    function renderProdutos(filtro = "") {
      const container = document.getElementById("lista-produtos");
      container.innerHTML = "";
      produtosTemp
        .filter(p => !filtro || p.categoria === filtro)
        .forEach((p, idx) => {
          container.innerHTML += `
            <div class="item">
              <label>Nome</label>
              <input type="text" value="${p.nome}" onchange="updateProduto(${idx}, 'nome', this.value)">
              
              <label>Categoria</label>
              <select onchange="updateProduto(${idx}, 'categoria', this.value)">
                ${categoriasTemp.map(c => `
                  <option value="${c.slug}" ${p.categoria === c.slug ? "selected" : ""}>${c.nome}</option>
                `).join("")}
              </select>

              <label>Descri√ß√£o</label>
              <textarea rows="3" onchange="updateProduto(${idx}, 'descricao', this.value)">${p.descricao || ""}</textarea>

              <label>Pre√ßo</label>
              <input type="text" value="${p.preco || ""}" onchange="updateProduto(${idx}, 'preco', this.value)">

              <label>Imagens (URLs separadas por v√≠rgula)</label>
              <input type="text" value="${(p.imagens || []).join(", ")}" onchange="updateImagens(${idx}, this.value)">
              ${(p.imagens || []).map(img => `<img src="${img}" class="preview-img">`).join("")}

              <label>Selo</label>
              <input type="text" value="${p.selo || ""}" placeholder="Ex: Frete Gr√°tis" onchange="updateProduto(${idx}, 'selo', this.value)">

              <label>Posi√ß√£o do selo</label>
              <select onchange="updateProduto(${idx}, 'posicaoSelo', this.value)">
                <option value="top" ${p.posicaoSelo === "top" ? "selected" : ""}>Acima</option>
                <option value="bottom" ${p.posicaoSelo === "bottom" ? "selected" : ""}>Abaixo</option>
              </select>

              <button onclick="removerProduto(${idx})">üóëÔ∏è Remover</button>
            </div>
          `;
        });
    }

    // ========================
    // A√á√ïES
    // ========================
    function novoProduto() {
      produtosTemp.push({
        id: "p" + Date.now().toString(36),
        nome: "Novo Produto",
        categoria: categoriasTemp.length ? categoriasTemp[0].slug : "",
        descricao: "",
        preco: "",
        imagens: [],
        selo: "",
        posicaoSelo: "top"
      });
      renderProdutos();
    }

    function updateProduto(index, field, value) {
      produtosTemp[index][field] = value;
    }

    function updateImagens(index, value) {
      produtosTemp[index].imagens = value.split(",").map(v => v.trim()).filter(v => v);
      renderProdutos(document.getElementById("filtro-categoria").value);
    }

    function removerProduto(index) {
      if (confirm("Deseja remover este produto?")) {
        produtosTemp.splice(index, 1);
        renderProdutos();
      }
    }

    async function salvarProdutos() {
      await fetch(`${API}/products`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(produtosTemp)
      });
      alert("Produtos salvos!");
      listarProdutos();
    }

    function filtrarProdutos() {
      const filtro = document.getElementById("filtro-categoria").value;
      renderProdutos(filtro);
    }

    // ========================
    // INICIALIZA√á√ÉO
    // ========================
    listarCategorias();
    listarProdutos();
  </script>
</body>
</html>
